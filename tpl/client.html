<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22><text y=%2232%22 font-size=%2232%22>üè∏</text></svg>">
    <title>Badminton Live Score</title>
    <style>
      :root {
        --color-green: #1e8733;
        --square-size: 10rem;
      }
      html, body {
        margin: 0;
        background: #fff;
        font-family: sans-serif;
        color: #fff;
        height: 100%;
        text-align: center;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
        touch-action: manipulation;
      }

      .lock {
        position: absolute;
        height: 100%;
        width: 100%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        text-align: center;
        background: black;
        padding-top: 10%;
      }
      #size-lock {
        display: none;
        z-index: 99;
      }
      #portrait-lock {
        display: none;
        z-index: 98;
      }

      table#setup, table#counter {
        width: 100%;
        height: 100%;
      }

      table#setup {
        background: black;
        font-size: 2em;
      }
      table#setup #settings {
        margin: 0 auto;
      }
      table#setup select, input, button {
        font-size: 2rem;
        width: 16rem;
      }

      table#counter {
        table-layout: fixed;
      }
      table#counter td {
        background: var(--color-green);
        border: 2px solid #fff;
      }      
      table#counter .square {
        height: var(--square-size);
        width: var(--square-size);
        font-size: calc(.5 * var(--square-size));
      }
      table#counter .square-width {
        width: var(--square-size);
      }

      table#counter .team {
        height: calc(var(--square-size) / 2);
        font-size: 2vw;
      }
      table#counter .score {
        background: black;
        font-size: calc(2 * var(--square-size));
      }
      table#counter .set {
        background: black;
        font-size: calc(.75 * var(--square-size)) !important;
      }
      table#counter .button {
        font-size: calc(.6 * var(--square-size));
        font-weight: bold;
      }

      @media screen and (orientation: portrait) {
        #portrait-lock {
          display: block;
        }
        table {
          display: none;
        }
      }
      @media screen and (orientation: portrait) and ((max-device-width: 450px) or (max-device-height: 250px)) {
        #size-lock {
          display: block;
        }
        table {
          display: none;
        }
      }

      @media screen and (max-device-width: 1280px) {
        :root {
          --square-size: 8rem;
        }
      }

      @media screen and (max-device-width: 1024px) {
        :root {
          --square-size: 6.5rem;
        }
      }

      @media screen and (max-device-width: 768px) {
        :root {
          --square-size: 5rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="size-lock" class="lock">
      Your screen is too small.
    </div>
    <div id="portrait-lock" class="lock">
      Please rotate your device to landscape mode.
    </div>

    <table id="setup" style="display: table;">
      <tr>
        <td colspan="3">
          <table id="settings">
            <tr>
              <td><label for="mode">Mode:</label></td>
              <td>
                <select id="mode">
                  <option value="11">11 Pts., best of 5</option>
                  <option value="21" selected>21 Pts., best of 3</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                <label for="discipline">Discipline:</label>
              </td>
              <td>
                <select id="discipline" autocomplete="off" onchange="onDisciplineChange(this)">
                  <option value="singles" selected>Singles</option>
                  <option value="doubles">Doubles</option>
                </select>
              </td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <select id="team1country1" class="countries" autocomplete="off"></select>
          <input id="team1name1" type="text" placeholder="Player 1" autocomplete="off">
          <br>
          <select id="team1country2" class="countries doublesonly" autocomplete="off" disabled></select>
          <input id="team1name2" class="doublesonly" type="text" placeholder="Player 2" autocomplete="off" disabled>
        </td>
        <td>vs.</td>
        <td>
          <select id="team2country1" class="countries" autocomplete="off"></select>
          <input id="team2name1" type="text" placeholder="Player 1" autocomplete="off">
          <br>
          <select id="team2country2" class="countries doublesonly" autocomplete="off" disabled></select>
          <input id="team2name2" class="doublesonly" type="text" placeholder="Player 2" autocomplete="off" disabled>
        </td>
      </tr>
      <tr>
        <td colspan="3">
          <button onclick="onPlay()" >üè∏ Play!</button>
        </td>
      </tr>
    </table>

    <table id="counter" style="display: none;">
      <colgroup>
        <col />
        <col class="square-width" />
        <col class="square-width" />
        <col />
      </colgroup>
      <tr class="team">
        <td id="team-left" colspan="2"></td>
        <td id="team-right" colspan="2"></td>
      </tr>
      <tr>
        <td id="score-left" onclick="onScoreLeft()" class="score" rowspan="4">0</td>
        <td id="set-left" class="set square">0</td>
        <td id="set-right" class="set square">0</td>
        <td id="score-right" onclick="onScoreRight()" class="score" rowspan="4">0</td>
      </tr>
      <tr>
        <td onclick="onSwitch()" class="button" colspan="2">‚áÑ</td>
      </tr>
      <tr>
        <td onclick="onEnd()" class="button" colspan="2">‚úï</td>
      </tr>
      <tr>
        <td onclick="onUndoLeft()" class="square">‚Ü∂</td>
        <td onclick="onUndoRight()" class="square">‚Ü∂</td>
      </tr>
    </table>
    <script>
      const TEAM1V = 1;
      const TEAM2V = 2;
      const COUNTRIES = '[{"name":"Afghanistan","code":"AF","emoji":"üá¶üá´"},{"name":"√Öland Islands","code":"AX","emoji":"üá¶üáΩ"},{"name":"Albania","code":"AL","emoji":"üá¶üá±"},{"name":"Algeria","code":"DZ","emoji":"üá©üáø"},{"name":"American Samoa","code":"AS","emoji":"üá¶üá∏"},{"name":"Andorra","code":"AD","emoji":"üá¶üá©"},{"name":"Angola","code":"AO","emoji":"üá¶üá¥"},{"name":"Anguilla","code":"AI","emoji":"üá¶üáÆ"},{"name":"Antarctica","code":"AQ","emoji":"üá¶üá∂"},{"name":"Antigua & Barbuda","code":"AG","emoji":"üá¶üá¨"},{"name":"Argentina","code":"AR","emoji":"üá¶üá∑"},{"name":"Armenia","code":"AM","emoji":"üá¶üá≤"},{"name":"Aruba","code":"AW","emoji":"üá¶üáº"},{"name":"Ascension Island","code":"AC","emoji":"üá¶üá®"},{"name":"Australia","code":"AU","emoji":"üá¶üá∫"},{"name":"Austria","code":"AT","emoji":"üá¶üáπ"},{"name":"Azerbaijan","code":"AZ","emoji":"üá¶üáø"},{"name":"Bahamas","code":"BS","emoji":"üáßüá∏"},{"name":"Bahrain","code":"BH","emoji":"üáßüá≠"},{"name":"Bangladesh","code":"BD","emoji":"üáßüá©"},{"name":"Barbados","code":"BB","emoji":"üáßüáß"},{"name":"Belarus","code":"BY","emoji":"üáßüáæ"},{"name":"Belgium","code":"BE","emoji":"üáßüá™"},{"name":"Belize","code":"BZ","emoji":"üáßüáø"},{"name":"Benin","code":"BJ","emoji":"üáßüáØ"},{"name":"Bermuda","code":"BM","emoji":"üáßüá≤"},{"name":"Bhutan","code":"BT","emoji":"üáßüáπ"},{"name":"Bolivia","code":"BO","emoji":"üáßüá¥"},{"name":"Bosnia & Herzegovina","code":"BA","emoji":"üáßüá¶"},{"name":"Botswana","code":"BW","emoji":"üáßüáº"},{"name":"Bouvet Island","code":"BV","emoji":"üáßüáª"},{"name":"Brazil","code":"BR","emoji":"üáßüá∑"},{"name":"British Indian Ocean Territory","code":"IO","emoji":"üáÆüá¥"},{"name":"British Virgin Islands","code":"VG","emoji":"üáªüá¨"},{"name":"Brunei","code":"BN","emoji":"üáßüá≥"},{"name":"Bulgaria","code":"BG","emoji":"üáßüá¨"},{"name":"Burkina Faso","code":"BF","emoji":"üáßüá´"},{"name":"Burundi","code":"BI","emoji":"üáßüáÆ"},{"name":"Cambodia","code":"KH","emoji":"üá∞üá≠"},{"name":"Cameroon","code":"CM","emoji":"üá®üá≤"},{"name":"Canada","code":"CA","emoji":"üá®üá¶"},{"name":"Canary Islands","code":"IC","emoji":"üáÆüá®"},{"name":"Cape Verde","code":"CV","emoji":"üá®üáª"},{"name":"Caribbean Netherlands","code":"BQ","emoji":"üáßüá∂"},{"name":"Cayman Islands","code":"KY","emoji":"üá∞üáæ"},{"name":"Central African Republic","code":"CF","emoji":"üá®üá´"},{"name":"Ceuta & Melilla","code":"EA","emoji":"üá™üá¶"},{"name":"Chad","code":"TD","emoji":"üáπüá©"},{"name":"Chile","code":"CL","emoji":"üá®üá±"},{"name":"China","code":"CN","emoji":"üá®üá≥"},{"name":"Christmas Island","code":"CX","emoji":"üá®üáΩ"},{"name":"Clipperton Island","code":"CP","emoji":"üá®üáµ"},{"name":"Cocos (Keeling) Islands","code":"CC","emoji":"üá®üá®"},{"name":"Colombia","code":"CO","emoji":"üá®üá¥"},{"name":"Comoros","code":"KM","emoji":"üá∞üá≤"},{"name":"Congo - Brazzaville","code":"CG","emoji":"üá®üá¨"},{"name":"Congo - Kinshasa","code":"CD","emoji":"üá®üá©"},{"name":"Cook Islands","code":"CK","emoji":"üá®üá∞"},{"name":"Costa Rica","code":"CR","emoji":"üá®üá∑"},{"name":"Croatia","code":"HR","emoji":"üá≠üá∑"},{"name":"Cuba","code":"CU","emoji":"üá®üá∫"},{"name":"Cura√ßao","code":"CW","emoji":"üá®üáº"},{"name":"Cyprus","code":"CY","emoji":"üá®üáæ"},{"name":"Czechia","code":"CZ","emoji":"üá®üáø"},{"name":"C√¥te d‚ÄôIvoire","code":"CI","emoji":"üá®üáÆ"},{"name":"Denmark","code":"DK","emoji":"üá©üá∞"},{"name":"Diego Garcia","code":"DG","emoji":"üá©üá¨"},{"name":"Djibouti","code":"DJ","emoji":"üá©üáØ"},{"name":"Dominica","code":"DM","emoji":"üá©üá≤"},{"name":"Dominican Republic","code":"DO","emoji":"üá©üá¥"},{"name":"Ecuador","code":"EC","emoji":"üá™üá®"},{"name":"Egypt","code":"EG","emoji":"üá™üá¨"},{"name":"El Salvador","code":"SV","emoji":"üá∏üáª"},{"name":"England","code":"ENGLAND","emoji":"üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø"},{"name":"Equatorial Guinea","code":"GQ","emoji":"üá¨üá∂"},{"name":"Eritrea","code":"ER","emoji":"üá™üá∑"},{"name":"Estonia","code":"EE","emoji":"üá™üá™"},{"name":"Eswatini","code":"SZ","emoji":"üá∏üáø"},{"name":"Ethiopia","code":"ET","emoji":"üá™üáπ"},{"name":"European Union","code":"EU","emoji":"üá™üá∫"},{"name":"Falkland Islands","code":"FK","emoji":"üá´üá∞"},{"name":"Faroe Islands","code":"FO","emoji":"üá´üá¥"},{"name":"Fiji","code":"FJ","emoji":"üá´üáØ"},{"name":"Finland","code":"FI","emoji":"üá´üáÆ"},{"name":"France","code":"FR","emoji":"üá´üá∑"},{"name":"French Guiana","code":"GF","emoji":"üá¨üá´"},{"name":"French Polynesia","code":"PF","emoji":"üáµüá´"},{"name":"French Southern Territories","code":"TF","emoji":"üáπüá´"},{"name":"Gabon","code":"GA","emoji":"üá¨üá¶"},{"name":"Gambia","code":"GM","emoji":"üá¨üá≤"},{"name":"Georgia","code":"GE","emoji":"üá¨üá™"},{"name":"Germany","code":"DE","emoji":"üá©üá™"},{"name":"Ghana","code":"GH","emoji":"üá¨üá≠"},{"name":"Gibraltar","code":"GI","emoji":"üá¨üáÆ"},{"name":"Greece","code":"GR","emoji":"üá¨üá∑"},{"name":"Greenland","code":"GL","emoji":"üá¨üá±"},{"name":"Grenada","code":"GD","emoji":"üá¨üá©"},{"name":"Guadeloupe","code":"GP","emoji":"üá¨üáµ"},{"name":"Guam","code":"GU","emoji":"üá¨üá∫"},{"name":"Guatemala","code":"GT","emoji":"üá¨üáπ"},{"name":"Guernsey","code":"GG","emoji":"üá¨üá¨"},{"name":"Guinea","code":"GN","emoji":"üá¨üá≥"},{"name":"Guinea-Bissau","code":"GW","emoji":"üá¨üáº"},{"name":"Guyana","code":"GY","emoji":"üá¨üáæ"},{"name":"Haiti","code":"HT","emoji":"üá≠üáπ"},{"name":"Heard & McDonald Islands","code":"HM","emoji":"üá≠üá≤"},{"name":"Honduras","code":"HN","emoji":"üá≠üá≥"},{"name":"Hong Kong SAR China","code":"HK","emoji":"üá≠üá∞"},{"name":"Hungary","code":"HU","emoji":"üá≠üá∫"},{"name":"Iceland","code":"IS","emoji":"üáÆüá∏"},{"name":"India","code":"IN","emoji":"üáÆüá≥"},{"name":"Indonesia","code":"ID","emoji":"üáÆüá©"},{"name":"Iran","code":"IR","emoji":"üáÆüá∑"},{"name":"Iraq","code":"IQ","emoji":"üáÆüá∂"},{"name":"Ireland","code":"IE","emoji":"üáÆüá™"},{"name":"Isle of Man","code":"IM","emoji":"üáÆüá≤"},{"name":"Israel","code":"IL","emoji":"üáÆüá±"},{"name":"Italy","code":"IT","emoji":"üáÆüáπ"},{"name":"Jamaica","code":"JM","emoji":"üáØüá≤"},{"name":"Japan","code":"JP","emoji":"üáØüáµ"},{"name":"Jersey","code":"JE","emoji":"üáØüá™"},{"name":"Jordan","code":"JO","emoji":"üáØüá¥"},{"name":"Kazakhstan","code":"KZ","emoji":"üá∞üáø"},{"name":"Kenya","code":"KE","emoji":"üá∞üá™"},{"name":"Kiribati","code":"KI","emoji":"üá∞üáÆ"},{"name":"Kosovo","code":"XK","emoji":"üáΩüá∞"},{"name":"Kuwait","code":"KW","emoji":"üá∞üáº"},{"name":"Kyrgyzstan","code":"KG","emoji":"üá∞üá¨"},{"name":"Laos","code":"LA","emoji":"üá±üá¶"},{"name":"Latvia","code":"LV","emoji":"üá±üáª"},{"name":"Lebanon","code":"LB","emoji":"üá±üáß"},{"name":"Lesotho","code":"LS","emoji":"üá±üá∏"},{"name":"Liberia","code":"LR","emoji":"üá±üá∑"},{"name":"Libya","code":"LY","emoji":"üá±üáæ"},{"name":"Liechtenstein","code":"LI","emoji":"üá±üáÆ"},{"name":"Lithuania","code":"LT","emoji":"üá±üáπ"},{"name":"Luxembourg","code":"LU","emoji":"üá±üá∫"},{"name":"Macao SAR China","code":"MO","emoji":"üá≤üá¥"},{"name":"Madagascar","code":"MG","emoji":"üá≤üá¨"},{"name":"Malawi","code":"MW","emoji":"üá≤üáº"},{"name":"Malaysia","code":"MY","emoji":"üá≤üáæ"},{"name":"Maldives","code":"MV","emoji":"üá≤üáª"},{"name":"Mali","code":"ML","emoji":"üá≤üá±"},{"name":"Malta","code":"MT","emoji":"üá≤üáπ"},{"name":"Marshall Islands","code":"MH","emoji":"üá≤üá≠"},{"name":"Martinique","code":"MQ","emoji":"üá≤üá∂"},{"name":"Mauritania","code":"MR","emoji":"üá≤üá∑"},{"name":"Mauritius","code":"MU","emoji":"üá≤üá∫"},{"name":"Mayotte","code":"YT","emoji":"üáæüáπ"},{"name":"Mexico","code":"MX","emoji":"üá≤üáΩ"},{"name":"Micronesia","code":"FM","emoji":"üá´üá≤"},{"name":"Moldova","code":"MD","emoji":"üá≤üá©"},{"name":"Monaco","code":"MC","emoji":"üá≤üá®"},{"name":"Mongolia","code":"MN","emoji":"üá≤üá≥"},{"name":"Montenegro","code":"ME","emoji":"üá≤üá™"},{"name":"Montserrat","code":"MS","emoji":"üá≤üá∏"},{"name":"Morocco","code":"MA","emoji":"üá≤üá¶"},{"name":"Mozambique","code":"MZ","emoji":"üá≤üáø"},{"name":"Myanmar (Burma)","code":"MM","emoji":"üá≤üá≤"},{"name":"Namibia","code":"NA","emoji":"üá≥üá¶"},{"name":"Nauru","code":"NR","emoji":"üá≥üá∑"},{"name":"Nepal","code":"NP","emoji":"üá≥üáµ"},{"name":"Netherlands","code":"NL","emoji":"üá≥üá±"},{"name":"New Caledonia","code":"NC","emoji":"üá≥üá®"},{"name":"New Zealand","code":"NZ","emoji":"üá≥üáø"},{"name":"Nicaragua","code":"NI","emoji":"üá≥üáÆ"},{"name":"Niger","code":"NE","emoji":"üá≥üá™"},{"name":"Nigeria","code":"NG","emoji":"üá≥üá¨"},{"name":"Niue","code":"NU","emoji":"üá≥üá∫"},{"name":"Norfolk Island","code":"NF","emoji":"üá≥üá´"},{"name":"North Korea","code":"KP","emoji":"üá∞üáµ"},{"name":"North Macedonia","code":"MK","emoji":"üá≤üá∞"},{"name":"Northern Mariana Islands","code":"MP","emoji":"üá≤üáµ"},{"name":"Norway","code":"NO","emoji":"üá≥üá¥"},{"name":"Oman","code":"OM","emoji":"üá¥üá≤"},{"name":"Pakistan","code":"PK","emoji":"üáµüá∞"},{"name":"Palau","code":"PW","emoji":"üáµüáº"},{"name":"Palestinian Territories","code":"PS","emoji":"üáµüá∏"},{"name":"Panama","code":"PA","emoji":"üáµüá¶"},{"name":"Papua New Guinea","code":"PG","emoji":"üáµüá¨"},{"name":"Paraguay","code":"PY","emoji":"üáµüáæ"},{"name":"Peru","code":"PE","emoji":"üáµüá™"},{"name":"Philippines","code":"PH","emoji":"üáµüá≠"},{"name":"Pitcairn Islands","code":"PN","emoji":"üáµüá≥"},{"name":"Poland","code":"PL","emoji":"üáµüá±"},{"name":"Portugal","code":"PT","emoji":"üáµüáπ"},{"name":"Puerto Rico","code":"PR","emoji":"üáµüá∑"},{"name":"Qatar","code":"QA","emoji":"üá∂üá¶"},{"name":"Romania","code":"RO","emoji":"üá∑üá¥"},{"name":"Russia","code":"RU","emoji":"üá∑üá∫"},{"name":"Rwanda","code":"RW","emoji":"üá∑üáº"},{"name":"R√©union","code":"RE","emoji":"üá∑üá™"},{"name":"Samoa","code":"WS","emoji":"üáºüá∏"},{"name":"San Marino","code":"SM","emoji":"üá∏üá≤"},{"name":"Saudi Arabia","code":"SA","emoji":"üá∏üá¶"},{"name":"Scotland","code":"SCOTLAND","emoji":"üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø"},{"name":"Senegal","code":"SN","emoji":"üá∏üá≥"},{"name":"Serbia","code":"RS","emoji":"üá∑üá∏"},{"name":"Seychelles","code":"SC","emoji":"üá∏üá®"},{"name":"Sierra Leone","code":"SL","emoji":"üá∏üá±"},{"name":"Singapore","code":"SG","emoji":"üá∏üá¨"},{"name":"Sint Maarten","code":"SX","emoji":"üá∏üáΩ"},{"name":"Slovakia","code":"SK","emoji":"üá∏üá∞"},{"name":"Slovenia","code":"SI","emoji":"üá∏üáÆ"},{"name":"Solomon Islands","code":"SB","emoji":"üá∏üáß"},{"name":"Somalia","code":"SO","emoji":"üá∏üá¥"},{"name":"South Africa","code":"ZA","emoji":"üáøüá¶"},{"name":"South Georgia & South Sandwich Islands","code":"GS","emoji":"üá¨üá∏"},{"name":"South Korea","code":"KR","emoji":"üá∞üá∑"},{"name":"South Sudan","code":"SS","emoji":"üá∏üá∏"},{"name":"Spain","code":"ES","emoji":"üá™üá∏"},{"name":"Sri Lanka","code":"LK","emoji":"üá±üá∞"},{"name":"St. Barth√©lemy","code":"BL","emoji":"üáßüá±"},{"name":"St. Helena","code":"SH","emoji":"üá∏üá≠"},{"name":"St. Kitts & Nevis","code":"KN","emoji":"üá∞üá≥"},{"name":"St. Lucia","code":"LC","emoji":"üá±üá®"},{"name":"St. Martin","code":"MF","emoji":"üá≤üá´"},{"name":"St. Pierre & Miquelon","code":"PM","emoji":"üáµüá≤"},{"name":"St. Vincent & Grenadines","code":"VC","emoji":"üáªüá®"},{"name":"Sudan","code":"SD","emoji":"üá∏üá©"},{"name":"Suriname","code":"SR","emoji":"üá∏üá∑"},{"name":"Svalbard & Jan Mayen","code":"SJ","emoji":"üá∏üáØ"},{"name":"Sweden","code":"SE","emoji":"üá∏üá™"},{"name":"Switzerland","code":"CH","emoji":"üá®üá≠"},{"name":"Syria","code":"SY","emoji":"üá∏üáæ"},{"name":"S√£o Tom√© & Pr√≠ncipe","code":"ST","emoji":"üá∏üáπ"},{"name":"Taiwan","code":"TW","emoji":"üáπüáº"},{"name":"Tajikistan","code":"TJ","emoji":"üáπüáØ"},{"name":"Tanzania","code":"TZ","emoji":"üáπüáø"},{"name":"Thailand","code":"TH","emoji":"üáπüá≠"},{"name":"Timor-Leste","code":"TL","emoji":"üáπüá±"},{"name":"Togo","code":"TG","emoji":"üáπüá¨"},{"name":"Tokelau","code":"TK","emoji":"üáπüá∞"},{"name":"Tonga","code":"TO","emoji":"üáπüá¥"},{"name":"Trinidad & Tobago","code":"TT","emoji":"üáπüáπ"},{"name":"Tristan da Cunha","code":"TA","emoji":"üáπüá¶"},{"name":"Tunisia","code":"TN","emoji":"üáπüá≥"},{"name":"Turkey","code":"TR","emoji":"üáπüá∑"},{"name":"Turkmenistan","code":"TM","emoji":"üáπüá≤"},{"name":"Turks & Caicos Islands","code":"TC","emoji":"üáπüá®"},{"name":"Tuvalu","code":"TV","emoji":"üáπüáª"},{"name":"U.S. Outlying Islands","code":"UM","emoji":"üá∫üá≤"},{"name":"U.S. Virgin Islands","code":"VI","emoji":"üáªüáÆ"},{"name":"Uganda","code":"UG","emoji":"üá∫üá¨"},{"name":"Ukraine","code":"UA","emoji":"üá∫üá¶"},{"name":"United Arab Emirates","code":"AE","emoji":"üá¶üá™"},{"name":"United Kingdom","code":"GB","emoji":"üá¨üáß"},{"name":"United Nations","code":"UN","emoji":"üá∫üá≥"},{"name":"United States","code":"US","emoji":"üá∫üá∏"},{"name":"Uruguay","code":"UY","emoji":"üá∫üáæ"},{"name":"Uzbekistan","code":"UZ","emoji":"üá∫üáø"},{"name":"Vanuatu","code":"VU","emoji":"üáªüá∫"},{"name":"Vatican City","code":"VA","emoji":"üáªüá¶"},{"name":"Venezuela","code":"VE","emoji":"üáªüá™"},{"name":"Vietnam","code":"VN","emoji":"üáªüá≥"},{"name":"Wales","code":"WALES","emoji":"üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø"},{"name":"Wallis & Futuna","code":"WF","emoji":"üáºüá´"},{"name":"Western Sahara","code":"EH","emoji":"üá™üá≠"},{"name":"Yemen","code":"YE","emoji":"üáæüá™"},{"name":"Zambia","code":"ZM","emoji":"üáøüá≤"},{"name":"Zimbabwe","code":"ZW","emoji":"üáøüáº"}]';
      const MODES = new Map(Object.entries({
        "11": {
          winPoints: 11,
          tiePoints: 15,
          winGames: 3,
          maxGames: 5
        },
        "21": {
          winPoints: 21,
          tiePoints: 30,
          winGames: 2,
          maxGames: 3
        }
      }));

      // false: team 1 on left, team 2 on right
      // true:  team 1 on right, team 2 on left
      let switched = false;
      let match = {};
      let matchUuid = "";

      const onDisciplineChange = (elem) => {
        let isSingles = elem.value == "singles";

        [].forEach.call(
          document.getElementsByClassName("doublesonly"),
          (el) => {
            el.disabled = isSingles;
          }
        );
      }

      const onPlay = () => {
        const discipline = document.getElementById("discipline").value;

        const team1name1 = document.getElementById("team1name1").value.trim();
        const team1name2 = document.getElementById("team1name2").value.trim();
        const team2name1 = document.getElementById("team2name1").value.trim();
        const team2name2 = document.getElementById("team2name2").value.trim();

        if (team1name1 == "" || team2name1 == "")
          return;
        
        let team1 = [{
          country: document.getElementById("team1country1").value.trim(),
          player: team1name1
        }];
        let team2 = [{
          country: document.getElementById("team2country1").value.trim(),
          player: team2name1
        }];
        
        if (discipline === "doubles") {
          if (team1name2 == "" || team2name2 == "")
            return;

          team1.push({
            country: document.getElementById("team1country2").value.trim(),
            player: team1name2
          });
          team2.push({
            country: document.getElementById("team2country2").value.trim(),
            player: team2name2
          });
        }
        
        match = {
          info: {
            mode: parseInt(document.getElementById("mode").value),
            team1: team1,
            team2: team2,
            start: parseInt(Date.now() / 1000),
            end: null
          },
          games: [
            {
              points: []
            }
          ]
        }

        showCounter();

        initTransmit(() => {
          if (matchUuid == "") {
            alert("Match could not be transmitted to server. You can still count scores, however no live score is available for others.");
          } else {
            setInterval(transmit, 10000);
          }
        });
      }

      const showCounter = () => {
        document.getElementById("setup").style.display = "none";
        document.getElementById("counter").style.display = "table";

        render();
      }

      const onScoreLeft = () => {
        score(!switched ? TEAM1V : TEAM2V);
      }

      const onScoreRight = () => {
        score(!switched ? TEAM2V : TEAM1V);
      }

      const score = (team) => {
        match.games[match.games.length - 1].points.push(team);
        renderScores();

        // Determine whether game or match is finished
        const currentGame = match.games.slice(-1)[0] ?? { points: [] };

        const ownScore = currentGame.points.filter((p) => p == team).length;
        const otherScore = currentGame.points.filter((p) => p != team).length;

        const winPoints = MODES.get(match.info.mode.toString()).winPoints;
        const tiePoints = MODES.get(match.info.mode.toString()).tiePoints;

        if (ownScore == tiePoints || (ownScore >= winPoints && ownScore - otherScore >= 2)) {
          // Game was won by 'team', check whether whole match is won

          const lastPoints = match.games.map((g) => g.points.slice(-1));

          const ownWonGames = lastPoints.filter((p) => p == team).length
          const otherWonGames = lastPoints.filter((p) => p != team).length;

          const winGames = MODES.get(match.info.mode.toString()).winGames;
          const maxGames = MODES.get(match.info.mode.toString()).maxGames;

          if (ownWonGames == winGames || (ownWonGames + otherWonGames) == maxGames) {
            // Match was won by 'team'
            const scores = [];
            match.games.map((g) => g.points).forEach((pts) => {
              scoreTeam1 = pts.filter((p) => p == TEAM1V).length;
              scoreTeam2 = pts.filter((p) => p == TEAM2V).length;

              scores.push(
                (team == TEAM1V)
                ? scoreTeam1 + ":" + scoreTeam2
                : scoreTeam2 + ":" + scoreTeam1
              );
            });

            if (confirm("Please confirm: Match won by " + getTeamName(team) + " (" + scores.join(", ") + ").")) {
              match.info.end = parseInt(Date.now() / 1000);
              
              transmit(() => {
                window.location.href = "/";
              });
            } else {
              undo(team);
              renderScores();
            }
          } else {
            // Game was won but there is another game
            if (confirm("Please confirm: Game won by " + getTeamName(team) + " (" + ownScore + ":" + otherScore + ").")) {
              match.games.push({ points: [] });
              switched = !switched;

              render();
            } else {
              undo(team);
              renderScores();
            }
          }
        }
      }

      const onSwitch = () => {
        switched = !switched;
        render();
      }

      const onEnd = () => {
        if (confirm("End match without a winner?")) {
          window.location.href = "/";
        }
      }

      const onUndoLeft = () => {
        undo(!switched ? TEAM1V : TEAM2V);
      }

      const onUndoRight = () => {
        undo(!switched ? TEAM2V : TEAM1V);
      }

      const undo = (team) => {
        const lastOccurrence = match.games[match.games.length - 1].points.lastIndexOf(team);

        if (lastOccurrence !== -1) {
          match.games[match.games.length - 1].points.splice(lastOccurrence, 1);
        }

        renderScores();
      }

      const render = () => {
        renderTeams();
        renderScores();
        renderSets();
      }

      const getTeamName = (team) => {
        const getFlag = (cc) => {
          return cc.length == 0
          ? "üè≥Ô∏è"
          : String.fromCodePoint(
            cc.codePointAt(0) - 0x41 + 0x1F1E6,
            cc.codePointAt(1) - 0x41 + 0x1F1E6
          );
        };

        const players = (team == TEAM1V) ? match.info.team1 : match.info.team2;

        return players.map((t) => getFlag(t.country) + " " + t.player).join(" & ");
      }

      const renderTeams = () => {
        document.getElementById("team-left").innerText = getTeamName(!switched ? TEAM1V : TEAM2V);
        document.getElementById("team-right").innerText = getTeamName(!switched ? TEAM2V : TEAM1V);
      }

      const renderScores = () => {
        const currentGame = match.games.slice(-1)[0] ?? { points: [] };

        const score1 = currentGame.points.filter((p) => p == TEAM1V).length;
        const score2 = currentGame.points.filter((p) => p == TEAM2V).length;

        document.getElementById("score-left").innerText = (!switched ? score1 : score2);
        document.getElementById("score-right").innerText = (!switched ? score2 : score1);
      }

      const renderSets = () => {
        const lastPoints = match.games.slice(0, -1).map((g) => g.points.slice(-1)[0]);

        const set1 = lastPoints.filter((p) => p == TEAM1V).length;
        const set2 = lastPoints.filter((p) => p == TEAM2V).length;

        document.getElementById("set-left").innerText = (!switched ? set1 : set2);
        document.getElementById("set-right").innerText = (!switched ? set2 : set1);
      }

      const fillCountries = () => {
        const json = JSON.parse(COUNTRIES);
        
        [].forEach.call(
          document.getElementsByClassName("countries"),
          (select) => {
            // Manually add most commonly used countries on top
            const cn = document.createElement("option");
            cn.value = "CN";
            cn.innerHTML = "üá®üá≥ China";

            const de = document.createElement("option");
            de.value = "DE";
            de.innerHTML = "üá©üá™ Germany";

            const ina = document.createElement("option");
            ina.value = "ID";
            ina.innerHTML = "üáÆüá© Indonesia";

            const tw = document.createElement("option");
            tw.value = "TW";
            tw.innerHTML = "üáπüáº Taiwan";

            const sep = document.createElement("option");
            sep.value = "";
            sep.innerHTML = "----------";
            sep.disabled = true;

            select.append(cn);
            select.append(de);
            select.append(ina);
            select.append(tw);
            select.append(sep);

            select.value = "DE";
            
            json.map((c) => {
              let option = document.createElement("option");

              option.value = c.code.toUpperCase();
              option.innerHTML = c.emoji + " " + c.name;

              select.append(option);
            });
          }
        );
      }

      const initTransmit = (callback) => {
        fetch(window.location.origin + "/api/", {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({ action: "new" }),
        })
          .then(res => res.json())
          .then(res => { matchUuid = res.match })
          .finally(callback);
      }

      const transmit = (callback) => {
        if (matchUuid == "")
          return;
        
        fetch(window.location.origin + "/api/", {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({
            action: "update",
            match: matchUuid,
            data: match
          })
        })
          .finally(callback);
      }

      document.addEventListener("DOMContentLoaded", () => {
        fillCountries();
      });
    </script>
  </body>
</html>